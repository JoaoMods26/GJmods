// server.js
const express = require('express');
const crypto = require('crypto');
const app = express();
const PORT = process.env.PORT || 3000;

// Tu script LUA "protegido" (puede cargarse desde archivo en vez de inline)
const luaScript = `-- SCRIPT PROTEGIDO (ejemplo)
print("Este es el script protegido")
-- más código lua aquí...
`;

// Secreto para validación por query (mejor que nada, pero no perfecto)
const SECRET = process.env.SCRIPT_SECRET || "secreto-muy-fuerte-aqui";

// Helper: detectar peticiones desde 'Roblox' por User-Agent simple
function looksLikeRoblox(req) {
  const ua = (req.get('User-Agent') || '').toLowerCase();
  // muchos exploit runners ponen "Roblox" o "Lua" en User-Agent; no es fiable 100%
  return /roblox|lua|executor/i.test(ua);
}

// Endpoint que sirve el script (puede ser /script.lua)
app.get('/script.lua', (req, res) => {
  // Cabeceras CORS y cache control
  res.set({
    'Access-Control-Allow-Origin': '*',
    'Cache-Control': 'no-cache, no-store, must-revalidate',
    'Content-Type': 'text/plain; charset=utf-8'
  });

  // Método 1: detección por User-Agent
  if (looksLikeRoblox(req)) {
    return res.status(200).send(luaScript);
  }

  // Método 2: token en query (ej: /script.lua?token=abc123)
  const token = req.query.token || '';
  // validación simple: HMAC del timestamp (ejemplo). Aquí validamos igualdad directa con SECRET por simplicidad.
  if (token && token === SECRET) {
    return res.status(200).send(luaScript);
  }

  // Si no coincide, devolvemos 403 (o un HTML/cosa inocua)
  return res.status(403).send("403 Forbidden");
});

// Página web normal (index)
app.get('/', (req, res) => {
  res.set('Content-Type','text/html; charset=utf-8');
  res.send(`<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Página pública</title></head>
<body style="background:#111;color:#eee;font-family:Arial,Helvetica,sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;">
  <div style="text-align:center;max-width:720px">
    <h1>Bienvenido</h1>
    <p>Esta es la página pública. El script protegido no se muestra aquí.</p>
    <input id="codeInput" placeholder="Ingresa código" style="padding:8px;margin:8px" />
    <button onclick="tryShow()">Ver (simulado)</button>
    <pre id="out" style="background:#000;color:#0f0;padding:12px;display:none;max-height:300px;overflow:auto"></pre>
    <p id="msg" style="color:#f66"></p>
  </div>
<script>
function tryShow(){
  const code = document.getElementById('codeInput').value;
  const msg = document.getElementById('msg');
  const out = document.getElementById('out');
  msg.textContent = '';
  out.style.display = 'none';
  if(code === 'holauwu'){
    fetch('/script.lua?token=INVALID') // no revelará el script porque token es inválido
      .then(r => r.text())
      .then(t => {
        out.textContent = t;
        out.style.display = 'block';
      }).catch(e => {
        msg.textContent = 'No permitido';
      });
  } else {
    msg.textContent = 'No tienes acceso';
  }
}
</script>
</body>
</html>`);
});

app.listen(PORT, () => console.log(`Server listening on ${PORT}`));
