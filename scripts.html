<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rscripts App (via Cloudflare Worker)</title>
    <style>
      textarea {
        width: 100%;
        height: 200px;
      }
      #scripts-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        padding: 10px;
      }
      #scripts-container div {
        border: 1px solid #ccc;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <h1>Rscripts App (con Proxy Worker)</h1>
    <div id="scripts-container"></div>

    <script>
      const baseUrl = "https://workers-playground-curly-unit-2502.joao-lokofrank.workers.dev";

      // Helper: build URL
      function buildUrl(path) {
        return `${baseUrl}${path}`;
      }

      // Fetch y mostrar scripts
      fetch(buildUrl("/api/v2/scripts?page=1&orderBy=date&sort=desc"))
        .then((response) => response.json())
        .then((data) => {
          const scriptsContainer = document.getElementById("scripts-container");

          const scripts = data.scripts.map((script) => {
            const hasUser = script.user;
            const profilePicture = hasUser && script.user.image ? script.user.image : "https://i.pravatar.cc/300";
            const username = hasUser ? script.user.username : script.creator;

            const scriptElement = document.createElement("div");
            scriptElement.innerHTML = `
              <h2>${script.title}</h2>
              <p>${script.description}</p>
              <img style="width: 40px; height: 40px; border-radius: 50%;" src="${profilePicture}" alt="Profile picture of ${username}">
              <p>Creator: ${username}</p>
              <img src="${script.image}" alt="${script.title}">
              <textarea id="script-${script._id}"></textarea>
            `;

            const downloadUrl = script.rawScript;

            // Obtener contenido del script
            if (downloadUrl) {
              fetch(downloadUrl)
                .then((res) => res.text())
                .then((scriptContent) => {
                  const textArea = scriptElement.querySelector(`#script-${script._id}`);
                  textArea.value = scriptContent;
                })
                .catch((err) => {
                  console.error(`Error fetching script content for ${script.title}:`, err);
                });
            }

            return scriptElement;
          });

          scripts.forEach((el) => scriptsContainer.appendChild(el));
        })
        .catch((error) => console.error("Error fetching scripts:", error));

      // Registrar service worker para cache
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("sw.js")
          .then(() => console.log("Service Worker registrado âœ…"))
          .catch((err) => console.error("SW Error:", err));
      }
    </script>
  </body>
</html>
